# 스프링 시큐리티 기본 API 및 Filter 이해

# #1. 인증 API - 스프링 시큐리티 의존성 추가

### “스프링 시큐리티 의존성 추가 시 일어나는 일들”

- 서버가 가동되면 스프링 시큐리티의 초기화 작업 및 보안 설정이 이루어진다.
- 별도의 설정이나 구현을 하지 않아도 기본적인 웹 보안 기능이 현재 시스템에 연동되어 작동함
    1. 모든 요청은 인증이 되어야 자원에 접근이 가능하다.
    2. 인증 방식은 폼 로그인 방식과 httpBasic 로그인 방식을 제공한다.
    3. 기본 로그인 페이지를 제공한다.
    4. 기본 계정 한 개를 제공한다
        - username : user
        - password : 랜덤 문자열 제공

### “문제점”

- 계정 추가, 권한 추가, DB 연동 등
- 기본적인 보안 기능 외에 시스템에서 필요로 하는 더 세부적이고 추가적인 보안기능이 필요

# #2. 인증 API - 사용자 정의 보안 기능 구현

![1.png](images%2F1.png)

- **WebSecurityConfigurerAdapter**
    - 스프링 시큐리티의 가장 기본적인 웹 보안기능 초기화 및 활성화를 담당하는 클래스
    - HttpSecurity 클래스 생성
- HttpSecurity
    - 세부적인 보안 기능 설정을 위한 API를 제공하는 클래스

### “WebSecurityConfigurerAdapter Class에서 http 생성 메서드 확인”

```java
public abstract class WebSecurityConfigurerAdapter implements WebSecurityConfigurer<WebSecurity> {

// ... 이상 생략

	protected void configure(HttpSecurity http) throw Exception{
		
		this.logger.debug("Using default configure(HttpSecurity). "
				+ "If subclassed this will potentially override subclass configure(HttpSecurity).");

		// 모든 http 요청에 보안 검사를 적용함
		http.authorizeRequests((requests) -> requests.anyRequest().authenticated());

		// 로그인 인증 방식 제공
		http.formLogin();
  
    // httpBasic 인증 방식 제공
		http.httpBasic();

// ... 이하 생략

}
```

### “Custom SecurityConfig Class”

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {

        http
                .authorizeRequests()
                .anyRequest().authenticated(); // 인가 정책

        http
                .formLogin(); // 인증 정책 : 로그인 방식
    }
}
```

### “application.yml 설정”

```yaml
spring:
  security:
    user:
      name: user
      password: 1234
```

- 실행 결과

  ![2.png](images%2F2.png)

  ![3.png](images%2F3.png)

---
# #3. Form Login 인증

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/9e70fb36-94a9-4264-8764-03863a20b623/2e85dd2c-5f47-437c-ae1b-9829b4c4c0c1/Untitled.png)

- 사용자가 GET방식으로 /home에 접근
- 서버 자원에 접근하기 위해선 인증된 사용자만이 접근 가능하도록 보안 정책 설정
- 현재 사용자가 인증 받지 않은 경우, 로그인 페이지로 Redirect
- POST 방식으로 인증 시도
- Spring Security가 Session 생성
- Session에 인증 결과를 담은 인증 Token 객체 생성 (Authentication Type)
- SecurityContext에 Token 객체 실시간 저장
- 사용자는 인증 Token으로 자원에 계속해서 접근
- Spring Security는 Session에 저장된 인증 Token이 남아있다면 해당 User가 인증된 User임을 인식

<aside>
✅ `http.formLogin()` : Form 로그인 인증 기능이 작동함

</aside>

### “예시 코드”

```java
@Override
protected void configure(HttpSecurity http) throws Exception {

    http
            .authorizeRequests()
            .anyRequest().authenticated(); // 인가 정책

    http
            .formLogin()                                             // 인증 정책 : 로그인 방식
            .loginPage("/login.html")                                // 사용자 정의 로그인 페이지
            .failureUrl("/login.html?error=true") // 로그인 실패 후 이동 페이지
            .usernameParameter("username")                           // 아이디 파라미터명 설정 (default : username)
            .passwordParameter("password")                           // 패스워드 파라미터명 설정 (default : password)
            .loginProcessingUrl("/login")                            // 로그인 Form Action Url
            .successHandler(loginSuccessHandler())                   // 로그인 성공 후 핸들러
            .failureHandler(loginFailuerHandler());                  // 로그인 실패 후 핸들러
}
```

### “작성 코드”

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {

        http
                .authorizeRequests()
                .anyRequest().authenticated(); // 인가 정책

        http
                .formLogin()
                .loginPage("/loginPage") // API 지정 (해당 경로는 인증 과정을 pass해야함 -> 누구나 접근 가능하도록)
                .defaultSuccessUrl("/") // 인증 성공 후 root로 Redirect
                .failureUrl("/login") // 인증 실패 후 다시 login page로 Redirect
                .usernameParameter("userId") // 아이디 파라미터 이름을 userId로 지정
                .passwordParameter("passwd") // 패스워드 파라미터 이름을 passwd로 지정
                .loginProcessingUrl("/login_proc") // 로그인 프로세스 url 지정
                .successHandler(new AuthenticationSuccessHandler() {
                    @Override
                    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {

                        System.out.println("authentication: " + authentication.getName());
                        response.sendRedirect("/");
                    }
                }) // 로그인 성공 시 호출할 handler 지정
                .failureHandler(new AuthenticationFailureHandler() {
                    @Override
                    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {

                        System.out.println("exception: " + exception.getMessage());
                        response.sendRedirect("/login");
                    }
                }) // 로그인 실패 시 호출할 handler 지정
                .permitAll(); // 해당 page url은 누구나 접근 가능함
    }
}
```

- 실행 결과

  **************************“/loginPage”**************************

  ![5.png](images%2F5.png)

  ************“로그인 성공”************

  ![6.png](images%2F6.png)

  ![7.png](images%2F7.png)

  ### “로그인 실패 시”

  ![8.png](images%2F8.png)

  ### “파라미터명 적용 여부 확인”
  ![9.png](images%2F9.png)